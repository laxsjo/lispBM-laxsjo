
CC64 = x86_64-w64-mingw32-gcc
CC32 = i686-w64-mingw32-gcc

LISPBM := ../
include $(LISPBM)/lispbm.mk

PLATFORM_INCLUDE = -I$(LISPBM)/platform/windows/include
PLATFORM_SRC     = $(LISPBM)/platform/windows/src/platform_mutex.c

LBMFLAGS = -DFULL_RTS_LIB \
	   -DLBM_USE_DYN_MACROS \
           -DLBM_USE_DYN_LOOPS \
           -DLBM_USE_DYN_FUNS \
           -DLBM_USE_DYN_ARRAYS \
           -DLBM_USE_DYN_DEFSTRUCT \
           -DLBM_USE_TIME_QUOTA \
           -DLBM_USE_ERROR_LINENO

LIBS = windows/readline/lib/libhistory.dll.a windows/readline/lib/libreadline.dll.a
INC = -Iwindows/readline/include

CCFLAGS =  -g -O2 -Wall -Wconversion -Wsign-compare -pedantic -std=c11 $(LBMFLAGS) -Wno-pointer-to-int-cast -Wno-int-to-pointer-cast -fno-pie -no-pie

LISPBM_SRC += $(LISPBM_EVAL_CPS_SRC)

REPL_SRC= repl.c \
	  repl_exts.c \
          crc.c \
          packet.c

all:  windows/build/lbm32.exe

windows/build/lbm32.exe: $(REPL_SRC) $(LISPBM_SRC) $(LISPBM_DEPS) $(LISPBM_H)
	$(CC32) -DLBM_WIN $(CCFLAGS) $(LISPBM_SRC) $(PLATFORM_SRC) $(REPL_SRC) -o windows/build/lbm32.exe $(PLATFORM_INCLUDE) $(LISPBM_INC) $(INC) $(LIBS)


# Think this may need 64bit variant of libreadline.
# TODO: Try to build libreadline for 64bit windows.
#windows/build/lbm64.exe: repl_win.c
#	$(CC64) -DLBM_WIN -DLBM64 $(CCFLAGS) $(LISPBM_SRC) $(PLATFORM_SRC) $(REPL_SRC) -o windows/build/lbm64.exe $(PLATFORM_INCLUDE) $(LISPBM_INC) $(INC) $(LIBS)


clean:
	rm -f windows/build/lbm32.exe
	rm -f windows/build/lbm64.exe
